<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Focus Alarm</title>
    <style>
        /* --- Base & Theming --- */
        :root {
            --bg-color: #12121c;
            --card-bg: rgba(26, 26, 46, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent-primary: #4a90e2;
            --accent-secondary: #50e3c2;
            --danger-color: #e57373;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            
            --physics-color: #3b82f6;
            --chemistry-color: #f59e0b;
            --math-color: #22c55e;
            --others-color: #8b5cf6;
        }

        html.light-theme {
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --text-primary: #1c1c1e;
            --text-secondary: #6e6e73;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- SVG Icons --- */
        .icon {
            width: 1.5rem;
            height: 1.5rem;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- Layout & Containers --- */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--card-border);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .live-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }
        
        /* --- Countdown Widget --- */
        .countdown-widget {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            text-align: center;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .countdown-widget:hover {
            transform: translateY(-2px);
        }
        .countdown-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .countdown-timer {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--accent-secondary);
            font-variant-numeric: tabular-nums;
        }
        .countdown-timer span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0 0.25rem;
        }

        /* --- Add Alarm Panel --- */
        .add-alarm-panel {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        .add-alarm-panel summary {
            padding: 1.25rem 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .add-alarm-panel summary::-webkit-details-marker {
            display: none;
        }
        .add-alarm-panel summary::after {
            content: '+';
            font-size: 2rem;
            transition: transform 0.3s;
        }
        .add-alarm-panel[open] summary::after {
            transform: rotate(45deg);
        }
        .add-alarm-form {
            padding: 0 1.5rem 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .form-group input, .form-group select, .form-group textarea {
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 0.75rem;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }
        .repeat-days {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }
        .repeat-days label {
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--card-border);
            transition: background-color 0.2s, color 0.2s;
        }
        .repeat-days input {
            display: none;
        }
        .repeat-days input:checked + span {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* --- Filters & Search --- */
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        .filter-chip {
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .filter-chip:hover {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        .filter-chip.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        .search-input {
            flex-grow: 1;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 0.5rem 1rem;
            color: var(--text-primary);
            min-width: 150px;
        }

        /* --- Alarms Grid --- */
        .alarms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* --- Alarm Card --- */
        .alarm-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.25rem;
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
            opacity: 1;
            transform: scale(1);
        }
        .alarm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }
        .alarm-card.disabled {
            opacity: 0.6;
        }
        .alarm-card.firing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 var(--accent-secondary); }
            70% { box-shadow: 0 0 0 10px rgba(80, 227, 194, 0); }
            100% { box-shadow: 0 0 0 0 rgba(80, 227, 194, 0); }
        }

        .subject-stripe {
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }
        .subject-stripe.physics { background-color: var(--physics-color); }
        .subject-stripe.chemistry { background-color: var(--chemistry-color); }
        .subject-stripe.math { background-color: var(--math-color); }
        .subject-stripe.others { background-color: var(--others-color); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .alarm-time {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .alarm-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .subject-tag {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            color: white;
            font-weight: 500;
        }
        .subject-tag.physics { background-color: var(--physics-color); }
        .subject-tag.chemistry { background-color: var(--chemistry-color); }
        .subject-tag.math { background-color: var(--math-color); }
        .subject-tag.others { background-color: var(--others-color); }

        .alarm-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        .next-trigger {
            font-weight: 600;
            color: var(--accent-secondary);
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--card-border);
            padding-top: 1rem;
            margin-top: 1rem;
        }
        .card-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .card-actions button:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .card-actions button.delete:hover {
            color: var(--danger-color);
        }
        .conflict-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--chemistry-color);
            cursor: help;
        }

        /* --- Toggle Switch --- */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.1);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-primary);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* --- Modals --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bg-color);
            margin: 15% auto;
            padding: 2rem;
            border: 1px solid var(--card-border);
            width: 90%;
            max-width: 500px;
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px var(--shadow-color);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .close-button {
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: var(--text-primary);
        }
        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        /* --- Buttons --- */
        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        /* Custom File Input */
        #customToneDisplay {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #clearCustomTone {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* --- Utility --- */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <header>
            <h1 class="header-title">JEE Focus Alarm</h1>
            <div class="header-controls">
                <span class="live-time" id="liveTime"></span>
                <button id="settingsBtn" aria-label="Settings" class="card-actions-btn">
                    <!-- Unique Atom Icon for Settings -->
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="1.5"></circle>
                        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(45 12 12)"></ellipse>
                        <ellipse cx="12" cy="12" rx="10" ry="4" transform="rotate(-45 12 12)"></ellipse>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- COUNTDOWN WIDGET -->
            <div id="countdownWidget" class="countdown-widget">
                <div class="countdown-title">JEE Main Countdown</div>
                <div class="countdown-timer" id="countdownTimer">0d 0h 0m</div>
            </div>

            <!-- ADD ALARM PANEL -->
            <details class="add-alarm-panel" id="addAlarmPanel">
                <summary>Add New Alarm</summary>
                <form class="add-alarm-form" id="alarmForm">
                    <input type="hidden" id="alarmId">
                    <div class="form-group full-width">
                        <label for="title">Title</label>
                        <input type="text" id="title" value="JEE Revision" required>
                    </div>
                    <div class="form-group">
                        <label for="subject">Subject</label>
                        <select id="subject">
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="math">Math</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="time">Time</label>
                        <input type="time" id="time" required>
                    </div>
                    <div class="form-group">
                        <label for="preReminder">Pre-Reminder</label>
                        <select id="preReminder">
                            <option value="0">None</option>
                            <option value="5">5 minutes before</option>
                            <option value="10">10 minutes before</option>
                            <option value="15">15 minutes before</option>
                            <option value="30">30 minutes before</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Repeat</label>
                        <div class="repeat-days" id="repeatDays">
                            <!-- JS will generate day toggles -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="alarmToneSelect">Tone</label>
                        <select id="alarmToneSelect">
                            <option value="tone1">Beep Beep</option>
                            <option value="tone2">Digital</option>
                            <option value="tone3">Ascending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="customTone">Custom Tone (Overrides Selection)</label>
                        <input type="file" id="customTone" accept="audio/*">
                        <div id="customToneDisplay" class="hidden">
                            <span id="customToneName"></span>
                            <button type="button" id="clearCustomTone">&times;</button>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="note">Note (Optional)</label>
                        <textarea id="note" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="vibration">Vibration</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="vibration" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group full-width" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                        <button type="submit" class="btn">Save Alarm</button>
                        <button type="button" id="testToneBtn" class="btn btn-secondary">Test Tone</button>
                        <button type="button" id="cancelEditBtn" class="btn btn-secondary hidden">Cancel</button>
                    </div>
                </form>
            </details>

            <!-- FILTERS -->
            <div class="filters-row">
                <button class="filter-chip" data-filter="all">All</button>
                <button class="filter-chip" data-filter="physics">Physics</button>
                <button class="filter-chip" data-filter="chemistry">Chemistry</button>
                <button class="filter-chip" data-filter="math">Math</button>
                <button class="filter-chip" data-filter="others">Others</button>
                <button class="filter-chip" data-filter="enabled">Enabled</button>
                <button class="filter-chip" data-filter="today">Today</button>
                <input type="search" id="searchInput" class="search-input" placeholder="Search by title...">
            </div>

            <!-- ALARMS GRID -->
            <div class="alarms-grid" id="alarmsGrid">
                <!-- Alarm cards will be injected here by JS -->
            </div>
        </main>

        <!-- FOOTER -->
        <footer>
            <p>Pro tip: Plan your revision 15 mins before the alarm using the Pre-Reminder feature.</p>
        </footer>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <span class="close-button" id="closeSettingsModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="form-group">
                        <label for="jeeTargetDate">JEE Target Date</label>
                        <input type="date" id="jeeTargetDate" required>
                    </div>
                    <div class="form-group">
                        <label for="jeeTargetTime">JEE Target Time</label>
                        <input type="time" id="jeeTargetTime" required>
                    </div>
                     <div class="form-group">
                        <label for="globalAlarmTone">Default Alarm Tone</label>
                        <select id="globalAlarmTone">
                            <option value="tone1">Beep Beep</option>
                            <option value="tone2">Digital</option>
                            <option value="tone3">Ascending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="volume">Volume</label>
                        <input type="range" id="volume" min="0" max="1" step="0.1" value="0.8">
                    </div>
                    <div class="form-group">
                        <label for="themeToggle">Theme</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="themeToggle">
                            <span class="slider"></span>
                        </label>
                         <small style="color: var(--text-secondary); margin-left:10px;">(Dark / Light)</small>
                    </div>
                    <button type="submit" class="btn">Save Settings</button>
                </form>
            </div>
        </div>
    </div>
    
    <audio id="audioPlayer"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // === DOM Elements ===
    const liveTimeEl = document.getElementById('liveTime');
    const countdownWidget = document.getElementById('countdownWidget');
    const countdownTimerEl = document.getElementById('countdownTimer');
    const alarmForm = document.getElementById('alarmForm');
    const alarmsGrid = document.getElementById('alarmsGrid');
    const addAlarmPanel = document.getElementById('addAlarmPanel');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const repeatDaysContainer = document.getElementById('repeatDays');
    const filtersContainer = document.querySelector('.filters-row');
    const searchInput = document.getElementById('searchInput');
    const customToneInput = document.getElementById('customTone');
    const customToneDisplay = document.getElementById('customToneDisplay');
    const customToneName = document.getElementById('customToneName');
    const clearCustomToneBtn = document.getElementById('clearCustomTone');
    const alarmToneSelectForm = document.getElementById('alarmToneSelect');


    // Settings Modal Elements
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const settingsForm = document.getElementById('settingsForm');
    const jeeTargetDateInput = document.getElementById('jeeTargetDate');
    const jeeTargetTimeInput = document.getElementById('jeeTargetTime');
    const globalAlarmToneSelect = document.getElementById('globalAlarmTone');
    const volumeSlider = document.getElementById('volume');
    const themeToggle = document.getElementById('themeToggle');
    
    // Audio
    const audioPlayer = document.getElementById('audioPlayer');
    const testToneBtn = document.getElementById('testToneBtn');
    let audioContext;
    let alarmInterval;

    // === State Management ===
    let alarms = [];
    let settings = {};
    let activeFilters = {
        subject: 'all',
        status: 'all',
        search: ''
    };
    const defaultSettings = {
        jeeTargetDateTime: '2027-01-25T09:00:00', // Updated target
        tone: 'tone1',
        volume: 0.8,
        theme: 'dark'
    };
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    // === IndexedDB for Audio Storage ===
    let db;

    function initDB(callback) {
        const request = indexedDB.open('JeeAlarmAudioDB', 1);

        request.onerror = (event) => {
            console.error("Database error:", event.target.errorCode);
        };

        request.onupgradeneeded = (event) => {
            const dbInstance = event.target.result;
            dbInstance.createObjectStore('audioTones', { keyPath: 'id' });
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Database initialized successfully.");
            if (callback) callback();
        };
    }

    function saveAudio(id, audioBlob) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("DB not initialized");
            const transaction = db.transaction(['audioTones'], 'readwrite');
            const store = transaction.objectStore('audioTones');
            const request = store.put({ id: id, audio: audioBlob });
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject("Error saving audio: " + event.target.errorCode);
        });
    }

    function getAudio(id) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("DB not initialized");
            const transaction = db.transaction(['audioTones'], 'readonly');
            const store = transaction.objectStore('audioTones');
            const request = store.get(id);
            request.onsuccess = (event) => {
                if (event.target.result) resolve(event.target.result.audio);
                else reject("Audio not found");
            };
            request.onerror = (event) => reject("Error getting audio: " + event.target.errorCode);
        });
    }

    function deleteAudio(id) {
        return new Promise((resolve, reject) => {
            if (!db) return resolve();
            const transaction = db.transaction(['audioTones'], 'readwrite');
            const store = transaction.objectStore('audioTones');
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject("Error deleting audio: " + event.target.errorCode);
        });
    }


    function loadState() {
        const storedAlarms = localStorage.getItem('jeeAlarms');
        // IMPORTANT: The `customToneData` property is no longer stored in localStorage
        alarms = storedAlarms ? JSON.parse(storedAlarms) : [];
        
        const storedSettings = localStorage.getItem('jeeAlarmSettings');
        settings = storedSettings ? JSON.parse(storedSettings) : defaultSettings;

        if (alarms.length === 0) {
            seedInitialAlarms();
        }
    }

    function saveState() {
        try {
            // The `alarms` array no longer contains large audio data, preventing quota errors.
            localStorage.setItem('jeeAlarms', JSON.stringify(alarms));
            localStorage.setItem('jeeAlarmSettings', JSON.stringify(settings));
        } catch (e) {
            console.error("Error saving to localStorage:", e);
            alert("Could not save settings. Your browser's storage might be full or disabled.");
        }
    }
    
    function seedInitialAlarms() {
        alarms = [
            { id: 'seed1', title: 'Physics: Kinematics', subject: 'physics', date: '2025-09-10', time: '08:00', repeat: [1, 3, 5], preReminder: '10', vibration: true, note: 'Review projectile motion.', enabled: true, tone: 'tone1' },
            { id: 'seed2', title: 'Chemistry: Moles', subject: 'chemistry', date: '2025-09-11', time: '19:30', repeat: [], preReminder: '15', vibration: true, note: '', enabled: true, tone: 'tone2' },
            { id: 'seed3', title: 'Math: Calculus Practice', subject: 'math', date: '2025-09-12', time: '16:00', repeat: [2, 4], preReminder: '5', vibration: false, note: 'Focus on integration by parts.', enabled: false, tone: 'tone3' },
        ];
        saveState();
    }

    // === Rendering ===
    function renderAlarms() {
        alarmsGrid.innerHTML = '';
        
        const filteredAlarms = getFilteredAlarms();
        const now = new Date();

        filteredAlarms.sort((a, b) => {
            const nextA = computeNextOccurrence(a, now);
            const nextB = computeNextOccurrence(b, now);
            if (!nextA) return 1;
            if (!nextB) return -1;
            return nextA - nextB;
        });

        if (filteredAlarms.length === 0) {
            alarmsGrid.innerHTML = `<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">No alarms match your filters.</p>`;
            return;
        }

        filteredAlarms.forEach(alarm => {
            const card = createAlarmCard(alarm, now);
            alarmsGrid.appendChild(card);
        });
        
        detectConflicts();
    }

    function createAlarmCard(alarm, now) {
        const card = document.createElement('div');
        card.className = `alarm-card ${alarm.enabled ? '' : 'disabled'}`;
        card.dataset.id = alarm.id;

        const nextOccurrence = computeNextOccurrence(alarm, now);
        const nextTriggerText = alarm.enabled 
            ? (nextOccurrence ? formatNextTrigger(nextOccurrence, now) : 'Expired')
            : 'Disabled';

        const repeatText = alarm.repeat.length > 0
            ? alarm.repeat.map(dayIndex => daysOfWeek[dayIndex]).join(', ')
            : `On ${new Date(alarm.date + 'T00:00:00').toLocaleDateString()}`;

        const [hour, minute] = alarm.time.split(':');
        const ampmTime = new Date(0, 0, 0, hour, minute).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        card.innerHTML = `
            <div class="subject-stripe ${alarm.subject}"></div>
            <div class="card-header">
                <div>
                    <div class="alarm-time">${ampmTime}</div>
                    <div class="alarm-title">${alarm.title}</div>
                </div>
                <div class="subject-tag ${alarm.subject}">${alarm.subject}</div>
            </div>
            <div class="alarm-details">
                <div>Next: <span class="next-trigger">${nextTriggerText}</span></div>
                <div>${repeatText}</div>
                ${alarm.note ? `<div style="margin-top: 0.5rem; font-style: italic;">Note: ${alarm.note}</div>` : ''}
            </div>
            <div class="card-footer">
                <div class="card-actions">
                    <button class="edit" aria-label="Edit">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="delete" aria-label="Delete">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" class="enable-toggle" ${alarm.enabled ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="conflict-badge hidden" title="This alarm clashes with another one.">
                <svg class="icon" viewBox="0 0 24 24" style="width:1.2rem; height:1.2rem;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </div>
        `;
        return card;
    }

    function renderRepeatDays() {
        repeatDaysContainer.innerHTML = daysOfWeek.map((day, index) => `
            <label>
                <input type="checkbox" name="repeat" value="${index}">
                <span>${day.charAt(0)}</span>
            </label>
        `).join('');
    }

    // === Time & Scheduling ===
    function scheduleTick() {
        setInterval(() => {
            const now = new Date();
            updateLiveTime(now);
            updateCountdown(now);
            checkAlarms(now);
            updateNextTriggerTimes(now);
        }, 1000);
    }

    function updateLiveTime(now) {
        liveTimeEl.textContent = now.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });
    }

    function updateCountdown(now) {
        const targetDate = new Date(settings.jeeTargetDateTime);
        const diff = targetDate - now;

        if (diff <= 0) {
            countdownTimerEl.textContent = "All the best!";
            return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        countdownTimerEl.innerHTML = `${d}<span>d</span> ${h}<span>h</span> ${m}<span>m</span>`;
    }

    function computeNextOccurrence(alarm, fromDate) {
        const [hour, minute] = alarm.time.split(':').map(Number);
        
        if (alarm.repeat.length === 0) {
            const occurrence = new Date(alarm.date + `T${alarm.time}`);
            return occurrence > fromDate ? occurrence : null;
        }

        for (let i = 0; i < 14; i++) { // Check for next 2 weeks
            const checkDate = new Date(fromDate);
            checkDate.setDate(fromDate.getDate() + i);
            const dayOfWeek = checkDate.getDay();

            if (alarm.repeat.includes(dayOfWeek)) {
                const potentialOccurrence = new Date(checkDate);
                potentialOccurrence.setHours(hour, minute, 0, 0);
                if (potentialOccurrence > fromDate) {
                    return potentialOccurrence;
                }
            }
        }
        
        return null;
    }

    function checkAlarms(now) {
        alarms.forEach(alarm => {
            if (!alarm.enabled) return;

            const nextOccurrence = computeNextOccurrence(alarm, now);
            if (!nextOccurrence) return;

            const diffSeconds = (nextOccurrence - now) / 1000;

            if (diffSeconds > 0 && diffSeconds <= 1) {
                triggerAlarm(alarm);
            }

            const preReminderMinutes = parseInt(alarm.preReminder, 10);
            if (preReminderMinutes > 0) {
                const preReminderTime = new Date(nextOccurrence.getTime() - preReminderMinutes * 60000);
                const preReminderDiffSeconds = (preReminderTime - now) / 1000;
                if (preReminderDiffSeconds > 0 && preReminderDiffSeconds <= 1) {
                    triggerPreReminder(alarm);
                }
            }
        });
    }

    function updateNextTriggerTimes(now) {
        document.querySelectorAll('.alarm-card').forEach(card => {
            const alarm = alarms.find(a => a.id === card.dataset.id);
            if (!alarm) return;
            const nextTriggerEl = card.querySelector('.next-trigger');
            if (nextTriggerEl) {
                const nextOccurrence = computeNextOccurrence(alarm, now);
                const nextTriggerText = alarm.enabled 
                    ? (nextOccurrence ? formatNextTrigger(nextOccurrence, now) : 'Expired')
                    : 'Disabled';
                if (nextTriggerEl.textContent !== nextTriggerText) {
                    nextTriggerEl.textContent = nextTriggerText;
                }
            }
        });
    }

    async function triggerAlarm(alarm) {
        console.log(`Triggering alarm: ${alarm.title}`);
        const card = document.querySelector(`.alarm-card[data-id="${alarm.id}"]`);
        if (card) {
            card.classList.add('firing');
            setTimeout(() => card.classList.remove('firing'), 5000);
        }
        showNotification(alarm.title, {
            body: `Subject: ${alarm.subject}\n${alarm.note || ''}`,
            vibrate: alarm.vibration ? [200, 100, 200] : []
        });
        
        if (alarm.tone === 'custom') {
            try {
                const audioBlob = await getAudio(alarm.id);
                const audioUrl = URL.createObjectURL(audioBlob);
                playCustomTone(audioUrl);
            } catch (error) {
                console.error("Could not play custom tone, falling back to default:", error);
                playTone(settings.tone, true);
            }
        } else {
            playTone(alarm.tone || settings.tone, true);
        }
    }
    
    function triggerPreReminder(alarm) {
        console.log(`Triggering pre-reminder for: ${alarm.title}`);
        showNotification(`Reminder: ${alarm.title}`, {
            body: `Starts in ${alarm.preReminder} minutes.`,
            vibrate: alarm.vibration ? [100, 50, 100] : []
        });
        playTone('tone1', false);
    }

    // === Audio & Notifications ===
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
    }

    function showNotification(title, options) {
        if (!('Notification' in window) || Notification.permission !== 'granted') {
            return;
        }
        new Notification(title, options);
    }
    
    function getAudioContext() {
        if (!audioContext || audioContext.state === 'closed') {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
    }

    function playTone(toneName, loop) {
        const ctx = getAudioContext();
        if (ctx.state === 'suspended') ctx.resume();
        stopTone();
        
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        gainNode.gain.value = settings.volume;

        switch (toneName) {
            case 'tone1': oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(880, ctx.currentTime); break;
            case 'tone2': oscillator.type = 'square'; oscillator.frequency.setValueAtTime(1000, ctx.currentTime); break;
            case 'tone3': 
                oscillator.type = 'triangle'; 
                oscillator.frequency.setValueAtTime(440, ctx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(880, ctx.currentTime + 1);
                break;
        }
        oscillator.start();
        if (loop) alarmInterval = setTimeout(stopTone, 30000);
        else setTimeout(() => oscillator.stop(), 500);
    }

    function playCustomTone(audioUrl) {
        stopTone();
        audioPlayer.src = audioUrl;
        audioPlayer.volume = settings.volume;
        audioPlayer.loop = true;
        audioPlayer.play();
        alarmInterval = setTimeout(stopTone, 30000);
    }

    function stopTone() {
        if (alarmInterval) {
            clearTimeout(alarmInterval);
            alarmInterval = null;
        }
        if (audioContext && audioContext.state === 'running') audioContext.close();
        if (!audioPlayer.paused) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (audioPlayer.src.startsWith('blob:')) {
                URL.revokeObjectURL(audioPlayer.src);
            }
            audioPlayer.src = '';
        }
    }

    // === Event Handlers ===
    alarmForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('alarmId').value || `alarm_${Date.now()}`;
        const isEditing = !!document.getElementById('alarmId').value;
        const existingAlarm = isEditing ? alarms.find(a => a.id === id) : null;
        const repeat = Array.from(document.querySelectorAll('input[name="repeat"]:checked')).map(cb => parseInt(cb.value));

        const alarmData = {
            id,
            title: document.getElementById('title').value,
            subject: document.getElementById('subject').value,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            repeat,
            preReminder: document.getElementById('preReminder').value,
            vibration: document.getElementById('vibration').checked,
            note: document.getElementById('note').value,
            enabled: true,
            tone: alarmToneSelectForm.value,
        };

        const customToneFile = customToneInput.files[0];
        if (customToneFile) {
            try {
                await saveAudio(id, customToneFile);
                alarmData.tone = 'custom';
            } catch (error) {
                console.error("Failed to save custom tone:", error);
                alert("Error: Could not save custom audio file.");
                return;
            }
        } else if (isEditing && existingAlarm.tone === 'custom' && !customToneDisplay.classList.contains('hidden')) {
            alarmData.tone = 'custom';
        } else if (isEditing && existingAlarm.tone === 'custom' && customToneDisplay.classList.contains('hidden')) {
            await deleteAudio(id);
        }
        
        if (isEditing) {
            const index = alarms.findIndex(a => a.id === id);
            alarms[index] = alarmData;
        } else {
            alarms.push(alarmData);
        }

        saveState();
        renderAlarms();
        resetForm();
        addAlarmPanel.open = false;
    });

    cancelEditBtn.addEventListener('click', resetForm);
    
    alarmsGrid.addEventListener('click', async (e) => {
        const target = e.target.closest('button, .enable-toggle');
        if (!target) return;

        const card = target.closest('.alarm-card');
        const alarmId = card.dataset.id;
        const alarm = alarms.find(a => a.id === alarmId);

        if (target.closest('.edit')) {
            await editAlarm(alarm);
        } else if (target.closest('.delete')) {
            if (confirm('Are you sure you want to delete this alarm?')) {
                await deleteAlarm(alarmId);
            }
        } else if (target.classList.contains('enable-toggle')) {
            toggleAlarm(alarmId, target.checked);
        }
    });

    filtersContainer.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const filterType = e.target.dataset.filter;
        filtersContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        if (['physics', 'chemistry', 'math', 'others', 'all'].includes(filterType)) {
            activeFilters.subject = filterType;
        } else {
            activeFilters.status = activeFilters.status === filterType ? 'all' : filterType;
        }
        renderAlarms();
    });

    searchInput.addEventListener('input', (e) => {
        activeFilters.search = e.target.value.toLowerCase();
        renderAlarms();
    });

    settingsBtn.addEventListener('click', openSettingsModal);
    closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
    window.addEventListener('click', (e) => {
        if (e.target == settingsModal) settingsModal.style.display = 'none';
    });
    countdownWidget.addEventListener('click', openSettingsModal);

    settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        settings.jeeTargetDateTime = `${jeeTargetDateInput.value}T${jeeTargetTimeInput.value}:00`;
        settings.tone = globalAlarmToneSelect.value;
        settings.volume = volumeSlider.value;
        settings.theme = themeToggle.checked ? 'light' : 'dark';
        applyTheme();
        saveState();
        settingsModal.style.display = 'none';
    });

    themeToggle.addEventListener('change', () => {
        document.documentElement.classList.toggle('light-theme', themeToggle.checked);
        document.documentElement.classList.toggle('dark-theme', !themeToggle.checked);
    });
    
    testToneBtn.addEventListener('click', () => {
        if (customToneInput.files[0]) {
             const reader = new FileReader();
             reader.onload = e => playCustomTone(URL.createObjectURL(customToneInput.files[0]));
             reader.readAsDataURL(customToneInput.files[0]);
        } else {
            playTone(alarmToneSelectForm.value, false);
        }
    });
    
    customToneInput.addEventListener('change', () => {
        if (customToneInput.files[0]) {
            customToneName.textContent = customToneInput.files[0].name;
            customToneDisplay.classList.remove('hidden');
        } else {
            customToneDisplay.classList.add('hidden');
        }
    });
    
    clearCustomToneBtn.addEventListener('click', () => {
        customToneInput.value = '';
        customToneDisplay.classList.add('hidden');
    });

    // === Alarm Actions ===
    async function editAlarm(alarm) {
        addAlarmPanel.open = true;
        window.scrollTo(0, 0);
        resetForm();

        document.getElementById('alarmId').value = alarm.id;
        document.getElementById('title').value = alarm.title;
        document.getElementById('subject').value = alarm.subject;
        document.getElementById('date').value = alarm.date;
        document.getElementById('time').value = alarm.time;
        document.getElementById('preReminder').value = alarm.preReminder;
        document.getElementById('vibration').checked = alarm.vibration;
        document.getElementById('note').value = alarm.note;
        alarmToneSelectForm.value = alarm.tone === 'custom' ? settings.tone : alarm.tone;

        if (alarm.tone === 'custom') {
            try {
                await getAudio(alarm.id);
                customToneName.textContent = "Custom tone saved";
                customToneDisplay.classList.remove('hidden');
            } catch (e) {
                alarm.tone = settings.tone; // Fix inconsistent data
            }
        }

        document.querySelectorAll('input[name="repeat"]').forEach(cb => {
            cb.checked = alarm.repeat.includes(parseInt(cb.value, 10));
        });

        cancelEditBtn.classList.remove('hidden');
    }

    async function deleteAlarm(id) {
        const alarmToDelete = alarms.find(a => a.id === id);
        if (alarmToDelete && alarmToDelete.tone === 'custom') {
            await deleteAudio(id);
        }
        alarms = alarms.filter(a => a.id !== id);
        saveState();
        renderAlarms();
    }

    function toggleAlarm(id, isEnabled) {
        const index = alarms.findIndex(a => a.id === id);
        if (index > -1) {
            alarms[index].enabled = isEnabled;
            saveState();
            const card = document.querySelector(`.alarm-card[data-id="${id}"]`);
            card.classList.toggle('disabled', !isEnabled);
            updateNextTriggerTimes(new Date());
        }
    }

    function resetForm() {
        alarmForm.reset();
        document.getElementById('alarmId').value = '';
        cancelEditBtn.classList.add('hidden');
        document.getElementById('title').value = 'JEE Revision';
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('date').value = tomorrow.toISOString().split('T')[0];
        customToneDisplay.classList.add('hidden');
    }

    // === Utilities ===
    function getFilteredAlarms() {
        return alarms.filter(alarm => {
            const subjectMatch = activeFilters.subject === 'all' || alarm.subject === activeFilters.subject;
            const statusMatch = activeFilters.status === 'all' ||
                (activeFilters.status === 'enabled' && alarm.enabled) ||
                (activeFilters.status === 'today' && isToday(computeNextOccurrence(alarm, new Date())));
            const searchMatch = alarm.title.toLowerCase().includes(activeFilters.search);
            return subjectMatch && statusMatch && searchMatch;
        });
    }

    function isToday(date) {
        if (!date) return false;
        const today = new Date();
        return date.getDate() === today.getDate() &&
               date.getMonth() === today.getMonth() &&
               date.getFullYear() === today.getFullYear();
    }

    function formatNextTrigger(date, now) {
        const diffDays = Math.floor((date - now) / 86400000);
        if (isToday(date)) {
            return `Today at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        if (date.toDateString() === tomorrow.toDateString()) {
             return `Tomorrow at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        }
        return date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
    }
    
    function detectConflicts() {
        const occurrences = {};
        document.querySelectorAll('.alarm-card:not(.disabled)').forEach(card => {
            const alarm = alarms.find(a => a.id === card.dataset.id);
            const next = computeNextOccurrence(alarm, new Date());
            if (next) {
                const key = next.toLocaleString();
                if (!occurrences[key]) occurrences[key] = [];
                occurrences[key].push(card);
            }
        });
        
        for (const key in occurrences) {
            if (occurrences[key].length > 1) {
                occurrences[key].forEach(card => {
                    card.querySelector('.conflict-badge').classList.remove('hidden');
                });
            }
        }
    }

    function openSettingsModal() {
        const [date, time] = settings.jeeTargetDateTime.split('T');
        jeeTargetDateInput.value = date;
        jeeTargetTimeInput.value = time.substring(0, 5);
        globalAlarmToneSelect.value = settings.tone;
        volumeSlider.value = settings.volume;
        themeToggle.checked = settings.theme === 'light';
        settingsModal.style.display = 'block';
    }

    function applyTheme() {
        document.documentElement.className = settings.theme === 'light' ? 'light-theme' : 'dark-theme';
        themeToggle.checked = settings.theme === 'light';
    }

    // === Initialization ===
    function init() {
        initDB(() => {
            loadState();
            applyTheme();
            renderRepeatDays();
            renderAlarms();
            scheduleTick();
            requestNotificationPermission();
            resetForm();
            filtersContainer.querySelector('[data-filter="all"]').classList.add('active');
        });
    }

    init();
});
</script>
</body>
</html>
